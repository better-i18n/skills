# GitHub Sync

Synchronize translations with your GitHub repository using AST-based key discovery.

## Overview

Better i18n GitHub Sync provides:
- **AST-based key discovery** - Finds translation keys in your code, not just JSON files
- **Two-way synchronization** - Import from repo, export to repo
- **Pull request workflow** - Review translation changes before merge
- **Automatic detection** - Discovers keys from `t()`, `useTranslations()`, etc.

## How It Works

```
Your Code                    Better i18n                  Your Repo
   │                              │                           │
   └── t('auth.login') ──────────▶│                           │
   └── useTranslations('common')──▶│ AST Parser               │
                                  │ discovers keys            │
                                  │      │                    │
                                  │      ▼                    │
                                  │ Creates/Updates          │
                                  │ translation keys         │
                                  │      │                    │
                                  │      ▼                    │
                                  │ Translator works ────────▶│ PR created
                                  │                           │ with JSON
```

## Setup

### 1. Install GitHub App

```
Project Settings → Integrations → GitHub → Install App
```

Grant access to repositories you want to sync.

### 2. Connect Repository

```
Project Settings → GitHub → Connect Repository

Repository: your-org/your-repo
Branch: main
```

### 3. Configure Paths

Specify where translation files should be synced:

```
Source Path: src/           # Where to scan for t() calls
Output Path: locales/       # Where to write JSON files
```

## Key Discovery

### Supported Patterns

Better i18n's AST parser detects keys from:

```typescript
// Function calls
t('auth.login.title')
t('common.buttons.submit', { name: 'John' })

// Hooks
const t = useTranslations('common')
t('title')  // Resolves to common.title

// next-intl patterns
const t = useTranslations('auth')
t('login.title')  // Resolves to auth.login.title
```

### Namespace Detection

Keys are organized by namespace automatically:

| Pattern | Detected Namespace | Full Key |
|---------|-------------------|----------|
| `useTranslations('auth')` + `t('login')` | auth | auth.login |
| `t('common.buttons.save')` | common | common.buttons.save |
| `getTranslations('dashboard')` | dashboard | dashboard.* |

## File Formats

### Supported Output Structures

**Flat JSON** (`/locales/en.json`)
```json
{
  "auth.login.title": "Sign In",
  "auth.login.submit": "Log In"
}
```

**Namespaced Folders** (`/locales/en/auth.json`)
```json
{
  "login.title": "Sign In",
  "login.submit": "Log In"
}
```

**Nested Objects** (`/locales/en.json`)
```json
{
  "auth": {
    "login": {
      "title": "Sign In",
      "submit": "Log In"
    }
  }
}
```

Configure in Project Settings → GitHub → File Format.

## Sync Modes

### Pull (Import Keys)

Import new keys discovered in your code:

```
Code changes → Push → Webhook → Better i18n scans code → Keys created
```

**Triggers:**
- Push to configured branch
- Manual sync from dashboard

### Push (Export Translations)

Export approved translations back to repository:

```
Translations approved → Publish → PR created → Merge → JSON updated
```

**Options:**
- Create PR (recommended for review)
- Direct commit (for automated workflows)

## Pull Request Workflow

### PR Configuration

```
Project Settings → GitHub → Pull Requests

Title: chore(i18n): Update {locale} translations
Branch prefix: i18n/
Auto-merge: Off
Reviewers: @translation-team
```

### Generated PR Content

```markdown
## Translation Updates

This PR updates translations for: **Turkish (tr)**

### Changes
| File | Keys Added | Keys Updated |
|------|-----------|--------------|
| common.json | 5 | 2 |
| auth.json | 0 | 3 |

### Summary
- Total keys: 45
- Translated: 43 (95.6%)
- Missing: 2

---
*Generated by Better i18n*
```

## Webhook Events

| Event | Action |
|-------|--------|
| `push` | Scan for new/changed keys in code |
| `pull_request.merged` | Mark translations as deployed |

Webhooks are verified using GitHub's HMAC-SHA256 signature.

## Conflict Resolution

### When Conflicts Occur

1. Same key modified in both GitHub and Better i18n
2. Key deleted in code but has translations
3. File structure changed

### Resolution Strategy

```
Project Settings → Sync → Conflict Resolution

Options:
- Better i18n wins (dashboard is truth)
- GitHub wins (code is truth)
- Manual review (pause and notify)
```

## Troubleshooting

### "Keys not discovered"

1. Check AST parser supports your pattern
2. Verify source path includes your code
3. Check for syntax errors in scanned files

### "Webhook not received"

1. Check GitHub App permissions
2. Verify repository is connected
3. Check webhook delivery logs in GitHub

### "PR not created"

1. Verify GitHub App has write access
2. Check branch protection allows bot PRs
3. Ensure no open PR exists (one at a time)

### "Sync stuck"

```
Project Settings → Sync → View Jobs → Cancel stuck job
```

## Best Practices

1. **Use feature branches** - Only sync production branch
2. **Review PRs** - Have translators review before merge
3. **Keep JSON valid** - Use ESLint/Prettier for JSON
4. **Document patterns** - Note i18n conventions in CONTRIBUTING.md
5. **Set up CI** - Validate translation files with `better-i18n check`

## CI/CD Integration

Add validation to your CI pipeline:

```yaml
# .github/workflows/i18n.yml
name: i18n Validation
on: [push, pull_request]

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v1
      - run: bun add -D @better-i18n/cli
      - run: bunx better-i18n check
```
